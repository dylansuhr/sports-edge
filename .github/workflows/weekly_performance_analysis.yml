name: Weekly Performance Analysis

on:
  schedule:
    # Every Sunday at 9 AM ET (1 PM UTC)
    - cron: '0 13 * * 0'
  workflow_dispatch:

jobs:
  analyze-and-tune:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r packages/models/requirements.txt

      - name: Run performance analysis
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          python ops/scripts/auto_analyze_performance.py --days 7 > /tmp/analysis.json

      - name: Run parameter tuning (dry-run)
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          python ops/scripts/auto_tune_parameters.py --dry-run

      - name: Generate CLV report
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          python ops/scripts/clv_report.py --days 7
