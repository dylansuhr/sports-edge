name: API Quota Monitoring

on:
  schedule:
    # Check quota twice daily: 8 AM and 8 PM UTC
    - cron: '0 8,20 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  check-quota:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install psycopg2-binary python-dotenv requests

      - name: Check API quota
        id: quota_check
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          THE_ODDS_API_KEY: ${{ secrets.THE_ODDS_API_KEY }}
        run: |
          set +e
          python ops/scripts/check_api_quota.py
          STATUS=$?
          set -e
          echo "exit_code=$STATUS" >> "$GITHUB_OUTPUT"
          if [ "$STATUS" -ne 0 ] && [ "$STATUS" -ne 1 ] && [ "$STATUS" -ne 2 ]; then
            exit $STATUS
          fi

      - name: Log quota alert
        if: steps.quota_check.outputs.exit_code == 1 || steps.quota_check.outputs.exit_code == 2
        run: |
          EXIT_CODE=${{ steps.quota_check.outputs.exit_code }}

          if [ "$EXIT_CODE" == "2" ]; then
            echo "::error::üö® CRITICAL: API Quota Exhausted!"
            echo "::error::API quota is completely exhausted (0 requests remaining)."
            echo "::error::All workflows that depend on The Odds API will fail until quota resets."
            echo ""
            echo "Recommended Actions:"
            echo "1. Wait for quota reset (typically 30 days after first API call)"
            echo "2. Odds ETL will auto-skip when quota exhausted (already configured)"
            echo "3. Consider upgrading to paid tier: https://the-odds-api.com/liveapi/guides/v4/#pricing"
          else
            echo "::warning::‚ö†Ô∏è WARNING: API Quota Running Low!"
            echo "::warning::API quota usage is above 95%."
            echo "::warning::Consider reducing polling frequency or upgrading to a paid plan."
          fi

          echo ""
          echo "### Impact"
          echo "- Odds ETL will skip runs (no fresh data until reset)"
          echo "- Signal generation will use existing odds"
          echo "- Paper betting will continue with existing signals"
          echo "- Settlement may fail for new games without odds data"
          echo ""
          echo "### Free Tier Limits"
          echo "- Total: 500 requests/month"
          echo "- Current schedule: ~16 requests/day = ~480/month"
          echo ""
          echo "### Upgrade Options"
          echo "- Starter: \$50/month (10,000 requests)"
          echo "- Pro: \$100/month (25,000 requests)"
          echo "- Premium: \$200/month (50,000 requests)"
