name: Milestone Readiness Check

on:
  schedule:
    # Run daily at 8 AM ET (12 PM UTC during standard time, 1 PM UTC during daylight time)
    - cron: '0 12 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  check-milestones:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r packages/models/requirements.txt

      - name: Check milestone readiness
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          python ops/scripts/check_milestone_readiness.py --send-alerts

      - name: Create issue if blocked for >7 days
        if: always()
        uses: actions/github-script@v7
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        with:
          script: |
            // Check if milestone has been blocked for more than 7 days
            const { execSync } = require('child_process');

            try {
              // Query database for blocked milestones
              const psqlCmd = `
                psql "${{ secrets.DATABASE_URL }}" -t -c "
                  SELECT
                    m.id,
                    m.name,
                    m.phase,
                    EXTRACT(DAY FROM (CURRENT_TIMESTAMP - MAX(mc.checked_at))) as days_blocked
                  FROM milestones m
                  LEFT JOIN milestone_checks mc ON m.id = mc.id AND mc.all_criteria_met = FALSE
                  WHERE m.status IN ('in_progress', 'blocked')
                  GROUP BY m.id, m.name, m.phase
                  HAVING EXTRACT(DAY FROM (CURRENT_TIMESTAMP - MAX(mc.checked_at))) > 7
                "
              `;

              const result = execSync(psqlCmd).toString().trim();

              if (result) {
                const rows = result.split('\n').filter(r => r.trim());

                for (const row of rows) {
                  const [id, name, phase, days] = row.split('|').map(s => s.trim());

                  const title = `⚠️ Milestone Blocked: ${name}`;
                  const body = `
## Milestone Alert

The **${name}** milestone (${phase}) has been blocked for **${days} days**.

### Details
- **Milestone ID:** ${id}
- **Phase:** ${phase}
- **Days Blocked:** ${days}

### Recommended Actions
1. Review milestone criteria in dashboard: \`/progress\`
2. Check \`ops/scripts/check_milestone_readiness.py\` output logs
3. Identify which criteria are not being met
4. Create action items to unblock

### Impact
- Phase advancement is blocked
- Unable to proceed to next milestone
- Sport addition may be delayed

**Check dashboard:** http://localhost:3000/progress
                  `;

                  // Check if issue already exists
                  const issues = await github.rest.issues.listForRepo({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    state: 'open',
                    labels: `milestone-blocked,milestone-${id}`
                  });

                  if (issues.data.length === 0) {
                    await github.rest.issues.create({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      title: title,
                      body: body,
                      labels: ['milestone-blocked', `milestone-${id}`, 'critical']
                    });
                    console.log(`Created issue for blocked milestone: ${name}`);
                  }
                }
              } else {
                console.log('No blocked milestones found');
              }
            } catch (error) {
              console.error('Error checking blocked milestones:', error);
            }
